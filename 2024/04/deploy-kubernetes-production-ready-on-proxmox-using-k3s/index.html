<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><title>Deploy Kubernetes on Proxmox using K3S - PiinAlpin Official Blog</title><meta name=Description content="Sharing is caring, keep learn and create an awesome codes."><meta property="og:title" content="Deploy Kubernetes on Proxmox using K3S">
<meta property="og:description" content="The documentation is describing the steps required to setup kubernetes cluster using K3S and learning automation provisioning using Terraform and Ansible on Proxmox VE. Before we setup kubernetes cluster, we need some prerequisities below.
Proxmox VE Ansible Terraform Disclaimer : I use WiFi network for my homelab server, you can check this documentation Setup Proxmox With Wireless Interface - My Homelab.
Setup Cloud Init Template This step is describe how to create cloud init template for provide provisioning virtual machine template on proxmox."><meta property="og:type" content="article"><meta property="og:url" content="https://piinalpin.com/2024/04/deploy-kubernetes-production-ready-on-proxmox-using-k3s/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-01T11:21:12+07:00"><meta property="article:modified_time" content="2024-04-01T11:21:12+07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploy Kubernetes on Proxmox using K3S"><meta name=twitter:description content="The documentation is describing the steps required to setup kubernetes cluster using K3S and learning automation provisioning using Terraform and Ansible on Proxmox VE. Before we setup kubernetes cluster, we need some prerequisities below.
Proxmox VE Ansible Terraform Disclaimer : I use WiFi network for my homelab server, you can check this documentation Setup Proxmox With Wireless Interface - My Homelab.
Setup Cloud Init Template This step is describe how to create cloud init template for provide provisioning virtual machine template on proxmox."><meta name=twitter:site content="@piinalpin"><meta name=application-name content="PiinAlpin Official Blog"><meta name=apple-mobile-web-app-title content="PiinAlpin Official Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=favicon.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://piinalpin.com/2024/04/deploy-kubernetes-production-ready-on-proxmox-using-k3s/><link rel=prev href=https://piinalpin.com/2024/03/setup-proxmox-with-wireless-interface/><link rel=next href=https://piinalpin.com/2024/07/build-kubernetes-cluster-on-proxmox-ve/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Deploy Kubernetes on Proxmox using K3S","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/piinalpin.com\/2024\/04\/deploy-kubernetes-production-ready-on-proxmox-using-k3s\/"},"image":["https:\/\/piinalpin.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"Kubernetes, Kubernetes Cluster, Ansible, Automation, Provisioning, Ansible Playbook, Kubeadm, Terraform, Cloud Init, Proxmox","wordcount":2197,"url":"https:\/\/piinalpin.com\/2024\/04\/deploy-kubernetes-production-ready-on-proxmox-using-k3s\/","datePublished":"2024-04-01T11:21:12+07:00","dateModified":"2024-04-01T11:21:12+07:00","publisher":{"@type":"Organization","name":"Alvinditya","logo":"https:\/\/piinalpin.com\/images\/favicon.png"},"author":{"@type":"Person","name":"Alvinditya Saputra"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="PiinAlpin Official Blog"><span class=header-title-pre><i class='fa fa-code fa-fw'></i> </span><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/piinalpin title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="PiinAlpin Official Blog"><span class=header-title-pre><i class='fa fa-code fa-fw'></i> </span><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/piinalpin title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Deploy Kubernetes on Proxmox using K3S</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://piinalpin.com/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Alvinditya Saputra</a></span>&nbsp;<span class=post-category>included in <a href=/categories/documentation/><i class="far fa-folder fa-fw"></i>Documentation</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2024-04-01>2024-04-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2197 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;11 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#setup-cloud-init-template>Setup Cloud Init Template</a></li><li><a href=#setup-terraform>Setup Terraform</a></li><li><a href=#setup-ansible>Setup Ansible</a></li><li><a href=#execute-automation>Execute Automation</a></li><li><a href=#references>References</a></li></ul></li></ul></nav></div></div><div class=content id=content><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/kubernetes-cluster.png data-srcset="/images/kubernetes-cluster.png, /images/kubernetes-cluster.png 1.5x, /images/kubernetes-cluster.png 2x" data-sizes=auto alt=/images/kubernetes-cluster.png title="Kubernetes Cluster in Proxmox"></p><p>The documentation is describing the steps required to setup kubernetes cluster using K3S and learning automation provisioning using <code>Terraform</code> and <code>Ansible</code> on Proxmox VE. Before we setup kubernetes cluster, we need some prerequisities below.</p><ul><li><a href=https://www.proxmox.com/en/proxmox-virtual-environment/get-started target=_blank rel="noopener noreffer">Proxmox VE</a></li><li><a href=https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html target=_blank rel="noopener noreffer">Ansible</a></li><li><a href=https://developer.hashicorp.com/terraform/install target=_blank rel="noopener noreffer">Terraform</a></li></ul><p><strong>Disclaimer :</strong> I use WiFi network for my homelab server, you can check this documentation <a href=https://piinalpin.com/2024/03/setup-proxmox-with-wireless-interface/ target=_blank rel="noopener noreffer">Setup Proxmox With Wireless Interface - My Homelab</a>.</p><h3 id=setup-cloud-init-template>Setup Cloud Init Template</h3><p>This step is describe how to create cloud init template for provide provisioning virtual machine template on proxmox. If you already have VM on proxmox server you can skip.</p><p>First, we need to remote on proxmox server using SSH or direct access into proxmox server. And we need to download operating system, I will use Ubuntu server 22.04 as cloud init template. Download the Ubuntu cloud init.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img
</span></span></code></pre></td></tr></table></div></div><p>Then, we need customize the iso images to enable <code>qemu agent</code>. Install <code>libguestfs-tools</code> if you don&rsquo;t have it.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt install libguestfs-tools
</span></span><span class=line><span class=cl>virt-customize -a jammy-server-cloudimg-amd64.img --install qemu-guest-agent,net-tools --truncate /etc/machine-id
</span></span></code></pre></td></tr></table></div></div><p>Create VM follow this command.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qm create <span class=m>8000</span> --name ubuntu-cloud-init --core <span class=m>2</span> --memory <span class=m>2048</span> --net0 virtio,bridge<span class=o>=</span>vmbr0
</span></span></code></pre></td></tr></table></div></div><p>It will create VM template with VM ID is <code>8000</code> and set default processor core is <code>2</code>, memory <code>2GB</code> and use VM bridge <code>vmbr0</code>as network interface.</p><p>Then, import disk into cloud init VM. This step is like we have storage but the SATA cable is not connected.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qm disk import <span class=m>8000</span> jammy-server-cloudimg-amd64.img local-lvm
</span></span></code></pre></td></tr></table></div></div><p>So, we need to attach disk into VM and setup boot order</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qm <span class=nb>set</span> <span class=m>8000</span> --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-8000-disk-0
</span></span><span class=line><span class=cl>qm <span class=nb>set</span> <span class=m>8000</span> --boot c --bootdisk scsi0
</span></span></code></pre></td></tr></table></div></div><p>Then activate qemu agent also set the serial socket vga for console and hotplug.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qm <span class=nb>set</span> <span class=m>8000</span> --agent <span class=m>1</span>
</span></span><span class=line><span class=cl>qm <span class=nb>set</span> <span class=m>8000</span> --serial0 socket
</span></span><span class=line><span class=cl>qm <span class=nb>set</span> <span class=m>8000</span> --vga serial0
</span></span><span class=line><span class=cl>qm <span class=nb>set</span> <span class=m>8000</span> --hotplug network,usb,disk
</span></span></code></pre></td></tr></table></div></div><p>Convert cloud init VM into template</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qm template <span class=m>8000</span>
</span></span></code></pre></td></tr></table></div></div><p>Create API Token that will be used for <code>Terraform</code>. Go to <code>Data Center</code> -> <code>Permissions</code> -> <code>API Tokens</code> then add new API token. <strong>Note :</strong> <em>Uncheck the <code>Privilege Separation</code></em> and don&rsquo;t forget to take a note the Token ID and Secret.</p><h3 id=setup-terraform>Setup Terraform</h3><p>Create file <code>variables.tf</code> to describe all variable and datatype that used when executing automation script.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;proxmox_api_url&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;proxmox_api_token_id&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;proxmox_api_token_secret&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ci_ssh_public_key&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ci_ssh_private_key&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ci_user&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ci_password&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ci_k8s_master_count&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>number</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ci_k8s_node_count&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>number</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ci_k8s_base_master_ip&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ci_k8s_base_node_ip&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ci_ip_gateway&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ci_network_cidr&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>number</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ci_start_vmid&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>number</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Create <code>credentials.auto.tfvars</code>, this file will assign value for each variable.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Proxmox API
</span></span><span class=line><span class=cl>proxmox_api_url             = &#34;https://192.168.56.1:8006/api2/json&#34;
</span></span><span class=line><span class=cl>proxmox_api_token_id        = &#34;terraform-prov@pve!terraform&#34;
</span></span><span class=line><span class=cl>proxmox_api_token_secret    = &#34;f6d89c4b-693c-47d6-b121-2932e747c75c&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Cloud init configuration
</span></span><span class=line><span class=cl>ci_ssh_public_key       = &#34;../.ssh/homelab.pub&#34;
</span></span><span class=line><span class=cl>ci_ssh_private_key      = &#34;../.ssh/homelab&#34;
</span></span><span class=line><span class=cl>ci_user                 = &#34;k8s&#34;
</span></span><span class=line><span class=cl>ci_password             = &#34;secret&#34;
</span></span><span class=line><span class=cl>ci_k8s_master_count     = 1
</span></span><span class=line><span class=cl>ci_k8s_node_count       = 2
</span></span><span class=line><span class=cl>ci_k8s_base_master_ip   = &#34;192.168.56.1&#34; # Will generate 192.168.56.1X
</span></span><span class=line><span class=cl>ci_k8s_base_node_ip     = &#34;192.168.56.2&#34; # Will generate 192.168.56.2X
</span></span><span class=line><span class=cl>ci_ip_gateway           = &#34;192.168.56.1&#34;
</span></span><span class=line><span class=cl>ci_network_cidr         = 24
</span></span><span class=line><span class=cl>ci_start_vmid           = 100
</span></span></code></pre></td></tr></table></div></div><p><strong>Note :</strong> Please adjust the <code>ci_ssh_public_key</code> and <code>ci_ssh_private_key</code> to your own SSH keys.</p><p>Create <code>provider.tf</code> to define what is the provider will be used. I will use <code>telmate/proxmox 3.0.1-rc1</code> because my proxmox version is <code>Proxmox 8.x</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=nx>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>required_version</span> = <span class=s2>&#34;&gt;= 1.7.4&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>required_providers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>proxmox</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>source</span> = <span class=s2>&#34;telmate/proxmox&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>version</span> = <span class=s2>&#34;3.0.1-rc1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>provider</span> <span class=s2>&#34;proxmox&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>pm_api_url</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>proxmox_api_url</span>
</span></span><span class=line><span class=cl>  <span class=na>pm_api_token_id</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>proxmox_api_token_id</span>
</span></span><span class=line><span class=cl>  <span class=na>pm_api_token_secret</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>proxmox_api_token_secret</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>pm_tls_insecure</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>pm_log_enable</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=na>pm_log_file</span>   = <span class=s2>&#34;terraform-plugin-proxmox.log&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>pm_debug</span>      = <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=na>pm_log_levels</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>_</span><span class=na>default</span>    = <span class=s2>&#34;debug&#34;</span>
</span></span><span class=line><span class=cl>    <span class=err>_</span><span class=na>capturelog</span> = <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Then create file <code>srv-k8s-cluster.tf</code> to execute automation provisioning creating VM for kubernetes cluster. This script actually execute this flow.</p><ul><li>Clone <code>ubuntu-cloud-init</code> template</li><li>Override cores count, memory and boot disk</li><li>Setup network and nameserver</li><li>Setup SSH key</li></ul><p>Based on <code>credentials.auto.tfvars</code> this script will create 1 master node and 2 worker nodes.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;proxmox_vm_qemu&#34;</span> <span class=s2>&#34;srv-k8s-master&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>count</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>ci_k8s_master_count</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span> = <span class=s2>&#34;k8s-master&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>desc</span> = <span class=s2>&#34;Kubernetes Master Nodes&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>vmid</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>ci_start_vmid</span> <span class=o>+</span> <span class=nb>count</span><span class=p>.</span><span class=nx>index</span>
</span></span><span class=line><span class=cl>  <span class=na>target_node</span> = <span class=s2>&#34;pve&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>clone</span> = <span class=s2>&#34;ubuntu-cloud-init&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>agent</span> = <span class=m>1</span>
</span></span><span class=line><span class=cl>  <span class=na>cores</span> = <span class=m>2</span>
</span></span><span class=line><span class=cl>  <span class=na>sockets</span> = <span class=m>1</span>
</span></span><span class=line><span class=cl>  <span class=na>cpu</span> = <span class=s2>&#34;host&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>memory</span> = <span class=m>4096</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>bootdisk</span> = <span class=s2>&#34;scsi0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>scsihw</span> = <span class=s2>&#34;virtio-scsi-pci&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>cloudinit_cdrom_storage</span> = <span class=s2>&#34;local-lvm&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>onboot</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>os_type</span> = <span class=s2>&#34;cloud-init&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>ipconfig0</span> = <span class=s2>&#34;ip=</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>ci_k8s_base_master_ip</span><span class=si>}${</span><span class=nb>count</span><span class=p>.</span><span class=nx>index</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>ci_network_cidr</span><span class=si>}</span><span class=s2>,gw=</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>ci_ip_gateway</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>nameserver</span> = <span class=s2>&#34;8.8.8.8 8.8.4.4 192.168.56.1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>searchdomain</span> = <span class=s2>&#34;piinalpin.lab&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>ciuser</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>ci_user</span>
</span></span><span class=line><span class=cl>  <span class=na>cipassword</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>ci_password</span>
</span></span><span class=line><span class=cl>  <span class=na>sshkeys</span> = <span class=o>&lt;&lt;EOF</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  ${file(var.ci_ssh_public_key)}
</span></span></span><span class=line><span class=cl><span class=s>  </span><span class=o>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>network</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>bridge</span> = <span class=s2>&#34;vmbr0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>model</span> = <span class=s2>&#34;virtio&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>disks</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>scsi</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>scsi0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>disk</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=na>size</span> = <span class=m>20</span>
</span></span><span class=line><span class=cl>          <span class=na>storage</span> = <span class=s2>&#34;local-lvm&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>lifecycle</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>ignore_changes</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=nx>network</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;proxmox_vm_qemu&#34;</span> <span class=s2>&#34;srv-k8s-nodes&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>count</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>ci_k8s_node_count</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span> = <span class=s2>&#34;k8s-node-</span><span class=si>${</span><span class=nb>count</span><span class=p>.</span><span class=nx>index</span> <span class=o>+</span> <span class=m>1</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>desc</span> = <span class=s2>&#34;Kubernetes Node </span><span class=si>${</span><span class=nb>count</span><span class=p>.</span><span class=nx>index</span> <span class=o>+</span> <span class=m>1</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>vmid</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>ci_start_vmid</span> <span class=o>+</span> <span class=p>(</span><span class=nb>count</span><span class=p>.</span><span class=nx>index</span> <span class=o>+</span> <span class=nb>var</span><span class=p>.</span><span class=nx>ci_k8s_master_count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=na>target_node</span> = <span class=s2>&#34;pve&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>clone</span> = <span class=s2>&#34;ubuntu-cloud-init&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>agent</span> = <span class=m>1</span>
</span></span><span class=line><span class=cl>  <span class=na>cores</span> = <span class=m>2</span>
</span></span><span class=line><span class=cl>  <span class=na>sockets</span> = <span class=m>1</span>
</span></span><span class=line><span class=cl>  <span class=na>cpu</span> = <span class=s2>&#34;host&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>memory</span> = <span class=m>4096</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>bootdisk</span> = <span class=s2>&#34;scsi0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>scsihw</span> = <span class=s2>&#34;virtio-scsi-pci&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>cloudinit_cdrom_storage</span> = <span class=s2>&#34;local-lvm&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>onboot</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>os_type</span> = <span class=s2>&#34;cloud-init&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>ipconfig0</span> = <span class=s2>&#34;ip=</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>ci_k8s_base_node_ip</span><span class=si>}${</span><span class=nb>count</span><span class=p>.</span><span class=nx>index</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>ci_network_cidr</span><span class=si>}</span><span class=s2>,gw=</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>ci_ip_gateway</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>nameserver</span> = <span class=s2>&#34;8.8.8.8 8.8.4.4 192.168.56.1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>searchdomain</span> = <span class=s2>&#34;piinalpin.lab&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>ciuser</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>ci_user</span>
</span></span><span class=line><span class=cl>  <span class=na>cipassword</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>ci_password</span>
</span></span><span class=line><span class=cl>  <span class=na>sshkeys</span> = <span class=o>&lt;&lt;EOF</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  ${file(var.ci_ssh_public_key)}
</span></span></span><span class=line><span class=cl><span class=s>  </span><span class=o>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>network</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>bridge</span> = <span class=s2>&#34;vmbr0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>model</span> = <span class=s2>&#34;virtio&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>disks</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>scsi</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>scsi0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>disk</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=na>size</span> = <span class=m>20</span>
</span></span><span class=line><span class=cl>          <span class=na>storage</span> = <span class=s2>&#34;local-lvm&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>lifecycle</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>ignore_changes</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=nx>network</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=setup-ansible>Setup Ansible</h3><p>For completely information step you can refer this documentation <a href=https://piinalpin.com/2024/03/deploy-kubernetes-on-vagrant-with-ansible/ target=_blank rel="noopener noreffer">Deploy Kubernetes Cluster on Vagrant With Ansible</a> then adjust the inventory.</p><p><strong>Inventory</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>all:vars<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>ansible_ssh_common_args</span><span class=o>=</span><span class=s1>&#39;-o StrictHostKeyChecking=no&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>k3s_token</span><span class=o>=</span>secret
</span></span><span class=line><span class=cl><span class=nv>k3s_master_ip</span><span class=o>=</span>192.168.56.10
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>master_nodes<span class=o>]</span>
</span></span><span class=line><span class=cl>k8s-master <span class=nv>ansible_ssh_host</span><span class=o>=</span>192.168.56.10 <span class=nv>ansible_ssh_port</span><span class=o>=</span><span class=m>22</span> <span class=nv>ansible_user</span><span class=o>=</span>k8s <span class=nv>ansible_ssh_private_key_file</span><span class=o>=</span>.ssh/homelab <span class=nv>node_ip</span><span class=o>=</span>192.168.56.10
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>master_nodes:vars<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>pod_network_cidr</span><span class=o>=</span>192.168.0.0/16
</span></span><span class=line><span class=cl><span class=nv>k3s_config_file</span><span class=o>=</span>/tmp/k3s-config.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>worker_nodes<span class=o>]</span>
</span></span><span class=line><span class=cl>k8s-node-1 <span class=nv>ansible_ssh_host</span><span class=o>=</span>192.168.56.20 <span class=nv>ansible_ssh_port</span><span class=o>=</span><span class=m>22</span> <span class=nv>ansible_user</span><span class=o>=</span>k8s <span class=nv>ansible_ssh_private_key_file</span><span class=o>=</span>.ssh/homelab <span class=nv>node_ip</span><span class=o>=</span>192.168.56.20
</span></span><span class=line><span class=cl>k8s-node-2 <span class=nv>ansible_ssh_host</span><span class=o>=</span>192.168.56.21 <span class=nv>ansible_ssh_port</span><span class=o>=</span><span class=m>22</span> <span class=nv>ansible_user</span><span class=o>=</span>k8s <span class=nv>ansible_ssh_private_key_file</span><span class=o>=</span>.ssh/homelab <span class=nv>node_ip</span><span class=o>=</span>192.168.56.21
</span></span></code></pre></td></tr></table></div></div><p>Download the <a href=https://raw.githubusercontent.com/piinalpin/home-lab-provisioning/main/playbooks/files/config.toml target=_blank rel="noopener noreffer"><strong>config.toml</strong></a> and put into <code>./playbooks/files/config.toml</code> to update <code>containerd.sock</code> runtime to prevent can&rsquo;t start kubelet while dialing <code>/var/run/containerd/containerd.sock</code>.</p><p>Create ansible playbook template file <code>./playbooks/templates/k3s-config.yaml.j2</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>write-kubeconfig-mode: &#39;0644&#39;
</span></span><span class=line><span class=cl>tls-san:
</span></span><span class=line><span class=cl>  - {{ k3s_master_ip }}
</span></span><span class=line><span class=cl>disable:
</span></span><span class=line><span class=cl>  - traefik
</span></span><span class=line><span class=cl>  - servicelb
</span></span><span class=line><span class=cl>  - local-storage
</span></span><span class=line><span class=cl>token: {{ k3s_token }}
</span></span><span class=line><span class=cl>docker: true
</span></span><span class=line><span class=cl>cluster-init: true
</span></span></code></pre></td></tr></table></div></div><p><strong>Ansible Playbook</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Setup Kubernetes Environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become_method</span><span class=p>:</span><span class=w> </span><span class=l>sudo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Remove generated ubuntu hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lineinfile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>regexp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ubuntu-*&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>absent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backup</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Remove generated hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lineinfile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>regexp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;.* {{ hostvars[item][&#39;ansible_hostname&#39;]}} {{ hostvars[item][&#39;ansible_hostname&#39;]}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>absent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backup</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_play_batch }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Update hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lineinfile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>regexp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;.*\t{{ hostvars[item][&#39;ansible_hostname&#39;]}}\t{{ hostvars[item][&#39;ansible_hostname&#39;]}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>line</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ hostvars[item][&#39;ansible_ssh_host&#39;] }}\t{{ hostvars[item][&#39;ansible_hostname&#39;]}}\t{{ hostvars[item][&#39;ansible_hostname&#39;]}}.local&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backup</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_play_batch }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install packages that allow apt to be used over HTTPS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>apt-transport-https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>ca-certificates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>curl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>gnupg-agent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>software-properties-common</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>update_cache</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Add an apt signing key for Docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apt_key</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://download.docker.com/linux/ubuntu/gpg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Add apt repository for stable version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apt_repository</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>repo</span><span class=p>:</span><span class=w> </span><span class=l>deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>filename</span><span class=p>:</span><span class=w> </span><span class=l>docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>update_cache</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install docker and dependecies</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apt</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>docker-ce </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>docker-ce-cli </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>containerd.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>update_cache</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>notify</span><span class=p>:</span><span class=w> </span><span class=l>Check docker status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Configure containerd config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>copy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.src }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.dest }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>with_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- {<span class=w> </span><span class=nt>src: config.toml, dest</span><span class=p>:</span><span class=w> </span><span class=l>/etc/containerd/config.toml }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Reload systemd daemon</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>systemctl daemon-reload</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Enable and start containerd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>containerd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>restarted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Add current user to docker group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>groups</span><span class=p>:</span><span class=w> </span><span class=l>docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>append</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Check docker status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Master Node Setup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>master_nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become_method</span><span class=p>:</span><span class=w> </span><span class=l>sudo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Copy k3s cluster config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>k3s-config.yaml.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ k3s_config_file }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Initialize kubernetes cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=l>curl -sfL https://get.k3s.io | K3S_CONFIG_FILE={{ k3s_config_file }} sh -s -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Setup kubeconfig for {{ ansible_user }} user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>with_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>rm -rf /home/{{ ansible_user }}/.kube</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mkdir -p /home/{{ ansible_user }}/.kube</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>cp -i /etc/rancher/k3s/k3s.yaml /home/{{ ansible_user }}/.kube/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>chown {{ ansible_user }}:{{ ansible_user }} /home/{{ ansible_user }}/.kube/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Check k3s.service status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>k3s.service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Worker Node Setup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>worker_nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become_method</span><span class=p>:</span><span class=w> </span><span class=l>sudo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Join the node to cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=l>curl -sfL https://get.k3s.io | K3S_TOKEN={{ k3s_token }} K3S_URL=https://{{ k3s_master_ip }}:6443 sh -s - --docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Check k3s-agent.service status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>k3s-agent.service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=execute-automation>Execute Automation</h3><p>Execute terraform and ansible</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init
</span></span><span class=line><span class=cl>terraform plan
</span></span><span class=line><span class=cl>terraform apply --auto-approve
</span></span><span class=line><span class=cl>ansible-playbook -i inventory/homelab.hosts playbooks/k3s-playbook.yaml
</span></span></code></pre></td></tr></table></div></div><p>Install some requirements</p><ul><li><a href=https://helm.sh/docs/intro/install/ target=_blank rel="noopener noreffer">Helm</a></li><li><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/ target=_blank rel="noopener noreffer">Kubectl</a></li></ul><p>Download kube config for kubernetes cluster, I usually using scp.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>scp -i .ssh/homelab -o <span class=nv>StrictHostKeyChecking</span><span class=o>=</span>no k8s@192.168.56.1:~/.kube/config ~/.kube/config
</span></span></code></pre></td></tr></table></div></div><p><strong>Installing Load Balancer</strong></p><p>Add helm repository</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add metallb https://metallb.github.io/metallb
</span></span></code></pre></td></tr></table></div></div><p>Install <code>MetalLB</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install metallb metallb/metallb -n metallb-system --create-namespace
</span></span></code></pre></td></tr></table></div></div><p>Create manifest <code>ipaddresspool.yaml</code> for ip address pool that kubernetes pod IP.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>metallb.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IPAddressPool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-pool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>metallb-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>addresses</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=m>192.168.56.101-192.168.56.254</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Apply ip address pool manifest</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ./.config/cluster/metallb/ipaddresspool.yaml
</span></span></code></pre></td></tr></table></div></div><p>Create advertisement <code>l2advertisement.yaml</code> to announce the node IP</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>metallb.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>L2Advertisement</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>metallb-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipAddressPools</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>default-pool</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Applu the L2 advertisement manifest</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ./.config/cluster/metallb/l2advertisement.yaml
</span></span></code></pre></td></tr></table></div></div><p><strong>Install Ingress Controller</strong></p><p>Add <code>nginx-ingress</code> repository</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add nginx-stable https://helm.nginx.com/stable
</span></span></code></pre></td></tr></table></div></div><p>Check and pull nginx ingress repository</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm search repo nginx
</span></span><span class=line><span class=cl>helm pull nginx-stable/nginx-ingress -d .helm --untar
</span></span></code></pre></td></tr></table></div></div><p>Modify <code>.helm/nginx-ingress/values.yaml</code> set <code>setAsDefaultIngress</code> to true</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ingressClass</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## A class of the Ingress Controller.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## IngressClass resource with the name equal to the class must be deployed. Otherwise,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## the Ingress Controller will fail to start.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## The Ingress Controller only processes resources that belong to its class - i.e. have the &#34;ingressClassName&#34; field resource equal to the class.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## The Ingress Controller processes all the resources that do not have the &#34;ingressClassName&#34; field for all versions of kubernetes.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Creates a new IngressClass object with the name &#34;controller.ingressClass.name&#34;. Set to false to use an existing IngressClass with the same name. If you use helm upgrade, do not change the values from the previous release as helm will delete IngressClass objects managed by helm. If you are upgrading from a release earlier than 3.3.0, do not set the value to false.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>create</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## New Ingresses without an ingressClassName field specified will be assigned the class specified in `controller.ingressClass`. Requires &#34;controller.ingressClass.create&#34;.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>setAsDefaultIngress</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Run helm chart to install ingress into kubernetes cluster</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm -n ingress install nginx-ingress -f .helm/nginx-ingress/values.yaml .helm/nginx-ingress/ --debug --create-namespace
</span></span></code></pre></td></tr></table></div></div><h3 id=references>References</h3><ul><li><a href="https://www.youtube.com/watch?v=shiIi38cJe4" target=_blank rel="noopener noreffer">Perfect Proxmox Template with Cloud Image and Cloud Init</a></li><li><a href="https://www.youtube.com/watch?v=ZGWn6xREdDE&amp;t=576s&amp;pp=ygURdGVycmFmb3JtIHByb3htb3g%3D" target=_blank rel="noopener noreffer">Automate Homelab Deployment With Terraform & Proxmox</a></li><li><a href="https://www.youtube.com/watch?v=RehsezEP2-E" target=_blank rel="noopener noreffer">Tutorial Terraform Proxmox Untuk PEMULA</a></li><li><a href="https://www.youtube.com/watch?v=w7qoTksCQow&amp;t=2325s" target=_blank rel="noopener noreffer">K3S: Setup dan Konfigurasi Mudah untuk Kubernetes Cluster</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-04-01</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2024/04/deploy-kubernetes-production-ready-on-proxmox-using-k3s/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://piinalpin.com/2024/04/deploy-kubernetes-production-ready-on-proxmox-using-k3s/ data-title="Deploy Kubernetes on Proxmox using K3S" data-via=piinalpin data-hashtags="Kubernetes,Kubernetes Cluster,Ansible,Automation,Provisioning,Ansible Playbook,Kubeadm,Terraform,Cloud Init,Proxmox"><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://piinalpin.com/2024/04/deploy-kubernetes-production-ready-on-proxmox-using-k3s/ data-hashtag=Kubernetes><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://piinalpin.com/2024/04/deploy-kubernetes-production-ready-on-proxmox-using-k3s/><i class="fab fa-linkedin fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/kubernetes/>Kubernetes</a>,&nbsp;<a href=/tags/kubernetes-cluster/>Kubernetes Cluster</a>,&nbsp;<a href=/tags/ansible/>Ansible</a>,&nbsp;<a href=/tags/automation/>Automation</a>,&nbsp;<a href=/tags/provisioning/>Provisioning</a>,&nbsp;<a href=/tags/ansible-playbook/>Ansible Playbook</a>,&nbsp;<a href=/tags/kubeadm/>Kubeadm</a>,&nbsp;<a href=/tags/terraform/>Terraform</a>,&nbsp;<a href=/tags/cloud-init/>Cloud Init</a>,&nbsp;<a href=/tags/proxmox/>Proxmox</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2024/03/setup-proxmox-with-wireless-interface/ class=prev rel=prev title="Setup Proxmox With Wireless Interface - My Homelab"><i class="fas fa-angle-left fa-fw"></i>Setup Proxmox With Wireless Interface - My Homelab</a>
<a href=/2024/07/build-kubernetes-cluster-on-proxmox-ve/ class=next rel=next title="Build Kubernetes Cluster on Proxmox VE">Build Kubernetes Cluster on Proxmox VE<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Piinalpin</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://piinalpin.com/ target=_blank>Alvinditya Saputra</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:20},comment:{},data:{"id-1":"PiinAlpin","id-2":"PiinAlpin"},search:{algoliaAppID:"Z6ALHE0FJ2",algoliaIndex:"test-index",algoliaSearchKey:"7308da79f682ce9c1c5b0cf4c9eb9249",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:0,speed:100}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>