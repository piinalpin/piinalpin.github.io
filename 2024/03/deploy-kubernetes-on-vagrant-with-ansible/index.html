<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><title>Deploy Kubernetes Cluster on Vagrant With Ansible - PiinAlpin Official Blog</title><meta name=Description content="Sharing is caring, keep learn and create an awesome codes."><meta property="og:title" content="Deploy Kubernetes Cluster on Vagrant With Ansible">
<meta property="og:description" content="The objective is describes the steps required to setup a multi node Kubernetes cluster for development purposes. This setup provides a production-like cluster that can be setup on your local machine. And we will use VirtualBox as the virtualization engine, Vagrant and Ansible for provisioning in our local environment. Before we setup kubernetes cluster, we need some prerequisities on our local machine below.
Oracle VM VirtualBox Vagrant Ansible Makesure you have setup network Host Only Adapter on your VirtualBox Why use Vagrant and Ansible?"><meta property="og:type" content="article"><meta property="og:url" content="https://piinalpin.com/2024/03/deploy-kubernetes-on-vagrant-with-ansible/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-10T12:34:18+07:00"><meta property="article:modified_time" content="2024-03-10T12:34:18+07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploy Kubernetes Cluster on Vagrant With Ansible"><meta name=twitter:description content="The objective is describes the steps required to setup a multi node Kubernetes cluster for development purposes. This setup provides a production-like cluster that can be setup on your local machine. And we will use VirtualBox as the virtualization engine, Vagrant and Ansible for provisioning in our local environment. Before we setup kubernetes cluster, we need some prerequisities on our local machine below.
Oracle VM VirtualBox Vagrant Ansible Makesure you have setup network Host Only Adapter on your VirtualBox Why use Vagrant and Ansible?"><meta name=twitter:site content="@piinalpin"><meta name=application-name content="PiinAlpin Official Blog"><meta name=apple-mobile-web-app-title content="PiinAlpin Official Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=favicon.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://piinalpin.com/2024/03/deploy-kubernetes-on-vagrant-with-ansible/><link rel=prev href=https://piinalpin.com/2023/12/why-clean-code-is-important/><link rel=next href=https://piinalpin.com/2024/03/setup-proxmox-with-wireless-interface/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Deploy Kubernetes Cluster on Vagrant With Ansible","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/piinalpin.com\/2024\/03\/deploy-kubernetes-on-vagrant-with-ansible\/"},"image":["https:\/\/piinalpin.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"Vagrant, Kubernetes, Kubernetes Cluster, Ansible, Automation, Provisioning, Ansible Playbook, Kubeadm, Virtualbox","wordcount":1959,"url":"https:\/\/piinalpin.com\/2024\/03\/deploy-kubernetes-on-vagrant-with-ansible\/","datePublished":"2024-03-10T12:34:18+07:00","dateModified":"2024-03-10T12:34:18+07:00","publisher":{"@type":"Organization","name":"Alvinditya","logo":"https:\/\/piinalpin.com\/images\/favicon.png"},"author":{"@type":"Person","name":"Alvinditya Saputra"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="PiinAlpin Official Blog"><span class=header-title-pre><i class='fa fa-code fa-fw'></i> </span><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/piinalpin title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="PiinAlpin Official Blog"><span class=header-title-pre><i class='fa fa-code fa-fw'></i> </span><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/piinalpin title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Deploy Kubernetes Cluster on Vagrant With Ansible</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://piinalpin.com/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Alvinditya Saputra</a></span>&nbsp;<span class=post-category>included in <a href=/categories/documentation/><i class="far fa-folder fa-fw"></i>Documentation</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2024-03-10>2024-03-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1959 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;10 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#why-use-vagrant-and-ansible>Why use Vagrant and Ansible?</a></li><li><a href=#setup-kubernetes-cluster>Setup Kubernetes Cluster</a><ul><li><a href=#creating-project-structure>Creating Project Structure</a></li><li><a href=#creating-vagrantfile>Creating Vagrantfile</a></li><li><a href=#create-additional-configuration>Create Additional Configuration</a></li><li><a href=#create-an-ansible-playbook-for-kubernetes-cluster>Create an Ansible Playbook for Kubernetes Cluster</a></li><li><a href=#setup-kubernetes-master>Setup Kubernetes Master</a></li><li><a href=#setup-kubernetes-nodes>Setup Kubernetes Nodes</a></li><li><a href=#execute-provisioning>Execute provisioning</a></li></ul></li><li><a href=#references>References</a></li></ul></li></ul></nav></div></div><div class=content id=content><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/vagrant-vm.png data-srcset="/images/vagrant-vm.png, /images/vagrant-vm.png 1.5x, /images/vagrant-vm.png 2x" data-sizes=auto alt=/images/vagrant-vm.png title="Kubernetes Cluster in Vagrant"></p><p>The objective is describes the steps required to setup a multi node Kubernetes cluster for development purposes. This setup provides a production-like cluster that can be setup on your local machine. And we will use VirtualBox as the virtualization engine, Vagrant and Ansible for provisioning in our local environment. Before we setup kubernetes cluster, we need some prerequisities on our local machine below.</p><ul><li><a href=https://www.virtualbox.org/wiki/Downloads target=_blank rel="noopener noreffer">Oracle VM VirtualBox</a></li><li><a href="https://developer.hashicorp.com/vagrant/install?product_intent=vagrant" target=_blank rel="noopener noreffer">Vagrant</a></li><li><a href=https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html target=_blank rel="noopener noreffer">Ansible</a></li><li>Makesure you have setup network <code>Host Only Adapter</code> on your VirtualBox</li></ul><h3 id=why-use-vagrant-and-ansible>Why use Vagrant and Ansible?</h3><p>Vagrant is a tool that will allow us to create a virtual environment easily and it eliminates pitfalls that cause the works-on-my-machine phenomenon. It can be used with multiple providers such as Oracle VirtualBox, VMware, Docker, and so on. It allows us to create a disposable environment by making use of configuration files.</p><p>Ansible is an infrastructure automation engine that automates software configuration management. It is agentless and allows us to use SSH keys for connecting to remote machines. Ansible playbooks are written in yaml and offer inventory management in simple text files.</p><h3 id=setup-kubernetes-cluster>Setup Kubernetes Cluster</h3><p>We will be setting up a Kubernetes cluster that will consist of one master and two worker nodes. All the nodes will run Ubuntu Xenial 64-bit OS and Ansible playbooks will be used for provisioning.</p><h4 id=creating-project-structure>Creating Project Structure</h4><p>We will create project structure like below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── ...
</span></span><span class=line><span class=cl>├── inventory/                
</span></span><span class=line><span class=cl>│   ├── vagrant.hosts                       # Define host target and variables to setup using ansible
</span></span><span class=line><span class=cl>├── playbooks/
</span></span><span class=line><span class=cl>│   ├── files/
</span></span><span class=line><span class=cl>│   │   └── config.toml                     # Containerd configuration
</span></span><span class=line><span class=cl>│   ├── templates/
</span></span><span class=line><span class=cl>│   │   ├── calico-custom-resource.yaml.j2  # Setup kubernetes pod network j2 template
</span></span><span class=line><span class=cl>│   │   └── joincluster.j2                  # Join kubernetes node to cluster command
</span></span><span class=line><span class=cl>│   └── ansible-playbook.yaml               # Ansible playbook file
</span></span><span class=line><span class=cl>├── vagrant-chmod-ssh.sh                    # Set read only generated ssh private key
</span></span><span class=line><span class=cl>├── Vagrantfile                             # Vagrant provisioning file
</span></span><span class=line><span class=cl>└── ...
</span></span></code></pre></td></tr></table></div></div><h4 id=creating-vagrantfile>Creating Vagrantfile</h4><p>Using your favourite IDE and create file <code>Vagrantfile</code> and inserting code below. For <code>WORKER_NODES_IPS</code> indicates how many worker or slave nodes present in the cluster. And this Vagrantfile configuration will be disable default port 22 for ssh and replace with incremental master ssh forwarded port.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Vagrantfile data-lang=Vagrantfile><span class=line><span class=cl><span class=no>IMAGE_NAME</span> <span class=o>=</span> <span class=s2>&#34;ubuntu/focal64&#34;</span>
</span></span><span class=line><span class=cl><span class=no>MASTER_NODE_IP</span> <span class=o>=</span> <span class=s2>&#34;192.168.56.2&#34;</span>
</span></span><span class=line><span class=cl><span class=no>MASTER_SSH_FORWARDED_PORT</span> <span class=o>=</span> <span class=mi>2722</span>
</span></span><span class=line><span class=cl><span class=no>WORKER_NODE_IPS</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;192.168.56.3&#34;</span><span class=p>,</span> <span class=s2>&#34;192.168.56.4&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=no>Vagrant</span><span class=o>.</span><span class=n>configure</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>config</span><span class=o>|</span>
</span></span><span class=line><span class=cl>    <span class=c1># Configure box</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>box</span> <span class=o>=</span> <span class=no>IMAGE_NAME</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>box_check_update</span> <span class=o>=</span> <span class=kp>false</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>network</span> <span class=ss>:forwarded_port</span><span class=p>,</span> <span class=ss>guest</span><span class=p>:</span> <span class=mi>22</span><span class=p>,</span> <span class=ss>host</span><span class=p>:</span> <span class=mi>2222</span><span class=p>,</span> <span class=nb>id</span><span class=p>:</span> <span class=s2>&#34;ssh&#34;</span><span class=p>,</span> <span class=ss>disabled</span><span class=p>:</span> <span class=kp>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Provision Master Node</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>define</span> <span class=s2>&#34;master&#34;</span> <span class=k>do</span> <span class=o>|</span><span class=n>master</span><span class=o>|</span>
</span></span><span class=line><span class=cl>        <span class=n>master</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>provider</span> <span class=s2>&#34;virtualbox&#34;</span> <span class=k>do</span> <span class=o>|</span><span class=n>v</span><span class=o>|</span>
</span></span><span class=line><span class=cl>            <span class=n>v</span><span class=o>.</span><span class=n>memory</span> <span class=o>=</span> <span class=mi>4096</span>
</span></span><span class=line><span class=cl>            <span class=n>v</span><span class=o>.</span><span class=n>cpus</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=n>v</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;k8s-master&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>master</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>hostname</span> <span class=o>=</span> <span class=s2>&#34;master&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>master</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>network</span> <span class=s2>&#34;private_network&#34;</span><span class=p>,</span> <span class=ss>ip</span><span class=p>:</span> <span class=no>MASTER_NODE_IP</span>
</span></span><span class=line><span class=cl>        <span class=n>master</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>network</span> <span class=s2>&#34;forwarded_port&#34;</span><span class=p>,</span> <span class=ss>guest</span><span class=p>:</span> <span class=mi>22</span><span class=p>,</span> <span class=ss>host</span><span class=p>:</span> <span class=no>MASTER_SSH_FORWARDED_PORT</span><span class=p>,</span> <span class=ss>auto_correct</span><span class=p>:</span> <span class=kp>true</span>
</span></span><span class=line><span class=cl>        <span class=n>master</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>network</span> <span class=s2>&#34;forwarded_port&#34;</span><span class=p>,</span> <span class=ss>guest</span><span class=p>:</span> <span class=mi>6443</span><span class=p>,</span> <span class=ss>host</span><span class=p>:</span> <span class=mi>6443</span><span class=p>,</span> <span class=ss>auto_correct</span><span class=p>:</span> <span class=kp>true</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Provision worker nodes</span>
</span></span><span class=line><span class=cl>    <span class=no>WORKER_NODE_IPS</span><span class=o>.</span><span class=n>each_with_index</span> <span class=k>do</span> <span class=o>|</span><span class=n>node_ip</span><span class=p>,</span> <span class=n>index</span><span class=o>|</span>
</span></span><span class=line><span class=cl>        <span class=n>hostname</span> <span class=o>=</span> <span class=s2>&#34;worker-</span><span class=si>#{</span><span class=s1>&#39;%02d&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>index</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>forwarded_port</span> <span class=o>=</span> <span class=no>MASTER_SSH_FORWARDED_PORT</span> <span class=o>+</span> <span class=n>index</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>define</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=n>hostname</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>do</span> <span class=o>|</span><span class=n>worker</span><span class=o>|</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>provider</span> <span class=s2>&#34;virtualbox&#34;</span> <span class=k>do</span> <span class=o>|</span><span class=n>v</span><span class=o>|</span>
</span></span><span class=line><span class=cl>                <span class=n>v</span><span class=o>.</span><span class=n>memory</span> <span class=o>=</span> <span class=mi>2048</span>
</span></span><span class=line><span class=cl>                <span class=n>v</span><span class=o>.</span><span class=n>cpus</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>                <span class=n>v</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;k8s-</span><span class=si>#{</span><span class=n>hostname</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>hostname</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=n>hostname</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>network</span> <span class=s2>&#34;private_network&#34;</span><span class=p>,</span> <span class=ss>ip</span><span class=p>:</span> <span class=n>node_ip</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>network</span> <span class=s2>&#34;forwarded_port&#34;</span><span class=p>,</span> <span class=ss>guest</span><span class=p>:</span> <span class=mi>22</span><span class=p>,</span> <span class=ss>host</span><span class=p>:</span> <span class=n>forwarded_port</span><span class=p>,</span> <span class=ss>auto_correct</span><span class=p>:</span> <span class=kp>true</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=create-additional-configuration>Create Additional Configuration</h4><p>Create <code>vagrant.hosts</code> at <code>./inventory/vagrant.hosts</code> to define which machine will be provision. Define the <code>ansible_ssh_host</code> using actual IP address on <code>Vagrantfile</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>all:vars<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>ansible_ssh_common_args</span><span class=o>=</span><span class=s1>&#39;-o StrictHostKeyChecking=no&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>master_nodes<span class=o>]</span>
</span></span><span class=line><span class=cl>master <span class=nv>ansible_ssh_host</span><span class=o>=</span>192.168.56.2 <span class=nv>ansible_ssh_port</span><span class=o>=</span><span class=m>22</span> <span class=nv>ansible_user</span><span class=o>=</span>vagrant <span class=nv>ansible_ssh_private_key_file</span><span class=o>=</span>.vagrant/machines/master/virtualbox/private_key <span class=nv>node_ip</span><span class=o>=</span>192.168.56.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>worker_nodes<span class=o>]</span>
</span></span><span class=line><span class=cl>worker-01 <span class=nv>ansible_ssh_host</span><span class=o>=</span>192.168.56.3 <span class=nv>ansible_ssh_port</span><span class=o>=</span><span class=m>22</span> <span class=nv>ansible_user</span><span class=o>=</span>vagrant <span class=nv>ansible_ssh_private_key_file</span><span class=o>=</span>.vagrant/machines/worker-01/virtualbox/private_key <span class=nv>node_ip</span><span class=o>=</span>192.168.56.3
</span></span><span class=line><span class=cl>worker-02 <span class=nv>ansible_ssh_host</span><span class=o>=</span>192.168.56.4 <span class=nv>ansible_ssh_port</span><span class=o>=</span><span class=m>22</span> <span class=nv>ansible_user</span><span class=o>=</span>vagrant <span class=nv>ansible_ssh_private_key_file</span><span class=o>=</span>.vagrant/machines/worker-02/virtualbox/private_key <span class=nv>node_ip</span><span class=o>=</span>192.168.56.4
</span></span></code></pre></td></tr></table></div></div><p>Download the <a href=https://raw.githubusercontent.com/piinalpin/home-lab-provisioning/main/playbooks/files/config.toml target=_blank rel="noopener noreffer"><strong>config.toml</strong></a> and put into <code>./playbooks/files/config.toml</code> to update <code>containerd.sock</code> runtime to prevent can&rsquo;t start kubelet while dialing <code>/var/run/containerd/containerd.sock</code>.</p><p><strong>Note:</strong> This based on my experience because I&rsquo;m facing this issue, so I override the address of <code>containerd.sock</code>.</p><h4 id=create-an-ansible-playbook-for-kubernetes-cluster>Create an Ansible Playbook for Kubernetes Cluster</h4><p>Create <code>ansible-playbook.yaml</code> at <code>./playbooks/ansible-playbook.yaml</code> and we will use single playbook file but we can define for all host, master and nodes hosts.</p><p><strong>Update hosts and Install some Required Packages</strong></p><p>We will update <code>/etc/hosts</code> on each remote target to register all of hostname and IP in ansible vars in this case is on <code>vagrant.hosts</code>. And install some packages below:</p><ul><li><code>apt-transport-https</code></li><li><code>ca-certificates</code></li><li><code>curl</code></li><li><code>gnupg-agent</code></li><li><code>software-properties-common</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Setup Kubernetes Environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become_method</span><span class=p>:</span><span class=w> </span><span class=l>sudo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Remove generated ubuntu hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lineinfile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>regexp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ubuntu-*&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>absent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backup</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Remove generated hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lineinfile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>regexp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;.* {{ hostvars[item][&#39;ansible_hostname&#39;]}} {{ hostvars[item][&#39;ansible_hostname&#39;]}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>absent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backup</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_play_batch }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Update hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lineinfile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>regexp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;.*\t{{ hostvars[item][&#39;ansible_hostname&#39;]}}\t{{ hostvars[item][&#39;ansible_hostname&#39;]}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>line</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ hostvars[item][&#39;ansible_ssh_host&#39;] }}\t{{ hostvars[item][&#39;ansible_hostname&#39;]}}\t{{ hostvars[item][&#39;ansible_hostname&#39;]}}.local&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backup</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_play_batch }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install packages that allow apt to be used over HTTPS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>apt-transport-https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>ca-certificates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>curl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>gnupg-agent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>software-properties-common</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>update_cache</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p> </p><p><strong>Install docker and required dependency</strong></p><p>We will installing the following packages and adding user into the docker group.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Add an apt signing key for Docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apt_key</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://download.docker.com/linux/ubuntu/gpg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Add apt repository for stable version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apt_repository</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>repo</span><span class=p>:</span><span class=w> </span><span class=l>deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install docker and dependecies</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apt</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>docker-ce </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>docker-ce-cli </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>containerd.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>update_cache</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>notify</span><span class=p>:</span><span class=w> </span><span class=l>Check docker status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Configure containerd config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>copy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.src }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.dest }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- {<span class=w> </span><span class=nt>src: config.toml, dest</span><span class=p>:</span><span class=w> </span><span class=l>/etc/containerd/config.toml }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Reload systemd daemon</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>systemctl daemon-reload</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Enable and start containerd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>containerd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>restarted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Add vagrant user to docker group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>groups</span><span class=p>:</span><span class=w> </span><span class=l>docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>append</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Don&rsquo;t forget to add handlers below</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Check docker status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p> </p><p><strong>Disabling system swap</strong></p><p>Kubelet will not start if system has swap enabled, so we are disabling swap using below code.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Remove swapfile from /etc/fstab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mount</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fstype</span><span class=p>:</span><span class=w> </span><span class=l>swap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>absent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>swap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>none</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Disable swap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>swapoff -a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>ansible_swaptotal_mb &gt; 0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p> </p><p><strong>Install kubelet, kubeadm and kubectl</strong></p><p>In this code we will check if kubernetes keyrings has been registered we will remove first before installing kubernetes. This is aimed at enabling automatic handling of provisioning errors post Kubernetes installation, as registered keyrings cannot be re-registered.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Ensure apt keyrings directory exists</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/apt/keyrings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Delete kubernetes keyrings if exists</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/apt/keyrings/kubernetes-apt-keyring.gpg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>absent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Add kubernetes APT repository key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=p>&gt;</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Add kubernetes repository to sources list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apt_repository</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>repo</span><span class=p>:</span><span class=w> </span><span class=l>deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>filename</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>update_cache</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install Kubernetes binaries</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apt</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>kubelet=1.29.*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>kubeadm=1.29.*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>kubectl=1.29.*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>update_cache</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Ensure /etc/default/kubelet exists</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/default/kubelet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Configure node ip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lineinfile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/default/kubelet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>line</span><span class=p>:</span><span class=w> </span><span class=l>KUBELET_EXTRA_ARGS=--node-ip={{ node_ip }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Restart kubelet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubelet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>restarted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>daemon_reload</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=setup-kubernetes-master>Setup Kubernetes Master</h4><p>Initialize kubernetes cluster on master node with <code>kubeadm</code> using below code. This will applicable only on Master node.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Master Node Setup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>master_nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become_method</span><span class=p>:</span><span class=w> </span><span class=l>sudo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pod_network_cidr</span><span class=p>:</span><span class=w> </span><span class=m>192.168.0.0</span><span class=l>/16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>custom_resource_remote_src</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/calico-custom-resource.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>join_cluster_remote_src</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/joincluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Initialize kubernetes cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm init --apiserver-advertise-address=&#34;{{ ansible_ssh_host }}&#34; --apiserver-cert-extra-sans=&#34;{{ ansible_ssh_host }}&#34; --node-name {{ ansible_hostname }} --pod-network-cidr={{ pod_network_cidr }}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p> </p><p><strong>Setup the kube config file</strong></p><p>Setup the <code>KUBE_CONFIG</code> file for <code>kubectl</code> command that allow user non root to accerss the Kubernetes cluster.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Setup kubeconfig for {{ ansible_user }} user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>mkdir -p /home/{{ ansible_user }}/.kube</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>cp -i /etc/kubernetes/admin.conf /home/{{ ansible_user }}/.kube/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>chown {{ ansible_user }}:{{ ansible_user }} /home/{{ ansible_user }}/.kube/config</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p> </p><p><strong>Setup pod networking provider</strong></p><p>We will use <code>calico</code> network as a provider for pod networking and network policy engine, so will use <code>tigera-operator</code>. Download the <a href=https://raw.githubusercontent.com/piinalpin/home-lab-provisioning/main/playbooks/templates/calico-custom-resource.yaml.j2 target=_blank rel="noopener noreffer"><strong>calico-custom-resource.yaml.j2</strong></a> ansible templates for customizing calico resource then put into <code>./playbooks/templates/calico-custom-resource.yaml.j2</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install calico pod network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.2/manifests/tigera-operator.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>install_calico_pod_network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Copy calico custom resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>calico-custom-resource.yaml.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ custom_resource_remote_src }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install custom resource pod network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>kubectl create -f {{ custom_resource_remote_src }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>install_calico_custom_resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>install_calico_pod_network is succeeded</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p> </p><p><strong>Generate kube join command</strong></p><p>This step will generate join command for kubernetes nodes into master node. First, we are creating file <code>./playbooks/templates/joincluster.j2</code> and fill with code below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=o>{{</span> join_cluster_command.stdout <span class=o>}}</span>
</span></span></code></pre></td></tr></table></div></div><p>Create ansible to generate join command and save the command in the file named <code>joincluster</code> that will be executed on kubernetes nodes.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Generate and save cluster join command</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm token create --print-join-command</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>join_cluster_command</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>install_calico_custom_resource is succeeded</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Save join command to file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>joincluster.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ join_cluster_remote_src }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>join_cluster_command is succeeded</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Fetch joincluster into local file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fetch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ join_cluster_remote_src }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>files/joincluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>flat</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=setup-kubernetes-nodes>Setup Kubernetes Nodes</h4><p>In the same ansible playbook we added configuration to setup kubernetes node to join cluster using generated join cluster that we store before.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Worker Node Setup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>worker_nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become_method</span><span class=p>:</span><span class=w> </span><span class=l>sudo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>join_cluster_remote_src</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/joincluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Copy the join command to server location</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>copy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>joincluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ join_cluster_remote_src }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=m>0777</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Join the node to cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>sh {{ join_cluster_remote_src }}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=execute-provisioning>Execute provisioning</h4><p>Upon completing the <code>Vagrantfile</code> and playbooks we can start to execute provisioning. Run vagrant by following command below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vagrant up
</span></span></code></pre></td></tr></table></div></div><p>And after all machine started we can execute provisioning using ansible playbook by following command below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ansible-playbook -i inventory/vagrant.hosts playbooks/ansible-playbook.yaml
</span></span></code></pre></td></tr></table></div></div><p>After all step and task completed, the kubernetes cluster should be up and running. We can login into the master or worker nodes using Vagrant or using host. I usually using host so it can be assumed as like run <code>kubectl</code> into remote server.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>config.yaml
</span></span><span class=line><span class=cl>$ kubectl get nodes
</span></span><span class=line><span class=cl>NAME         STATUS   ROLES    AGE     VERSION
</span></span><span class=line><span class=cl>k8s-master   Ready    master   18m     v1.29.2
</span></span><span class=line><span class=cl>worker-01    Ready    &lt;none&gt;   12m     v1.29.2
</span></span><span class=line><span class=cl>worker-02    Ready    &lt;none&gt;   6m22s   v1.29.2
</span></span></code></pre></td></tr></table></div></div><p>You can see all configuration files on my <a href=https://github.com/piinalpin/home-lab-provisioning target=_blank rel="noopener noreffer"><strong>Github</strong></a></p><h3 id=references>References</h3><ul><li><a href=https://kubernetes.io/blog/2019/03/15/kubernetes-setup-using-ansible-and-vagrant/#step-3-1-start-adding-the-code-from-steps-2-1-till-2-3 target=_blank rel="noopener noreffer">Kubernetes Setup Using Ansible and Vagrant</a></li><li><a href="https://www.youtube.com/watch?v=JJbUNRGoxmk&amp;t=75s" target=_blank rel="noopener noreffer">Install Kubernetes | 3 Node Cluster | v1.22.2 using Kubeadm | Vagrant | Vitrualbox | CKA</a></li><li><a href=https://github.com/ImaginCloud/kubernetes/tree/main/setup-k8s/vagrant-kubeadm target=_blank rel="noopener noreffer">Setup Kubernetes Cluster using Kubeadm using automated script v1.22.0</a></li><li><a href=https://github.com/akyriako/kubernetes-vagrant-ubuntu target=_blank rel="noopener noreffer">Kubernetes Vagrant Ubuntu</a></li><li><a href=https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart target=_blank rel="noopener noreffer">Quickstart for Calico on Kubernetes</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-03-10</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2024/03/deploy-kubernetes-on-vagrant-with-ansible/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://piinalpin.com/2024/03/deploy-kubernetes-on-vagrant-with-ansible/ data-title="Deploy Kubernetes Cluster on Vagrant With Ansible" data-via=piinalpin data-hashtags="Vagrant,Kubernetes,Kubernetes Cluster,Ansible,Automation,Provisioning,Ansible Playbook,Kubeadm,Virtualbox"><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://piinalpin.com/2024/03/deploy-kubernetes-on-vagrant-with-ansible/ data-hashtag=Vagrant><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://piinalpin.com/2024/03/deploy-kubernetes-on-vagrant-with-ansible/><i class="fab fa-linkedin fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/vagrant/>Vagrant</a>,&nbsp;<a href=/tags/kubernetes/>Kubernetes</a>,&nbsp;<a href=/tags/kubernetes-cluster/>Kubernetes Cluster</a>,&nbsp;<a href=/tags/ansible/>Ansible</a>,&nbsp;<a href=/tags/automation/>Automation</a>,&nbsp;<a href=/tags/provisioning/>Provisioning</a>,&nbsp;<a href=/tags/ansible-playbook/>Ansible Playbook</a>,&nbsp;<a href=/tags/kubeadm/>Kubeadm</a>,&nbsp;<a href=/tags/virtualbox/>Virtualbox</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2023/12/why-clean-code-is-important/ class=prev rel=prev title="Why Clean Code is Important?"><i class="fas fa-angle-left fa-fw"></i>Why Clean Code is Important?</a>
<a href=/2024/03/setup-proxmox-with-wireless-interface/ class=next rel=next title="Setup Proxmox With Wireless Interface - My Homelab">Setup Proxmox With Wireless Interface - My Homelab<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Piinalpin</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://piinalpin.com/ target=_blank>Alvinditya Saputra</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:20},comment:{},data:{"id-1":"PiinAlpin","id-2":"PiinAlpin"},search:{algoliaAppID:"Z6ALHE0FJ2",algoliaIndex:"test-index",algoliaSearchKey:"7308da79f682ce9c1c5b0cf4c9eb9249",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:0,speed:100}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>